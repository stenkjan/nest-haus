generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "rhel-openssl-3.0.x", "linux-musl", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model UserSession {
  id                String             @id @default(cuid())
  sessionId         String             @unique
  ipAddress         String?
  userAgent         String?
  referrer          String?
  utmSource         String?
  startTime         DateTime           @default(now())
  endTime           DateTime?
  lastActivity      DateTime           @default(now())
  configurationData Json?
  totalPrice        Int?
  status            SessionStatus      @default(ACTIVE)
  isOhneNestMode    Boolean            @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  selectionEvents   SelectionEvent[]
  interactionEvents InteractionEvent[]

  @@map("user_sessions")
}

model SelectionEvent {
  id                String      @id @default(cuid())
  sessionId         String
  timestamp         DateTime    @default(now())
  category          String
  selection         String
  previousSelection String?
  timeSpentMs       Int?
  priceChange       Int?
  totalPrice        Int?
  session           UserSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)

  @@map("selection_events")
}

model DailyAnalytics {
  id                      String   @id @default(cuid())
  date                    DateTime @unique @db.Date
  totalSessions           Int      @default(0)
  uniqueVisitors          Int      @default(0)
  completedConfigurations Int      @default(0)
  abandonedSessions       Int      @default(0)
  averageSessionDuration  Float    @default(0)
  bounceRate              Float    @default(0)
  conversionRate          Float    @default(0)
  topSelections           Json?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@map("daily_analytics")
}

model PopularConfiguration {
  id                String   @id @default(cuid())
  configurationHash String   @unique
  nestType          String
  gebaeudehuelle    String
  innenverkleidung  String
  fussboden         String
  pvanlage          String?
  fenster           String?
  planungspaket     String?
  totalPrice        Int
  selectionCount    Int      @default(1)
  conversionRate    Float    @default(0)
  lastSelected      DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("popular_configurations")
}

model HouseOption {
  id          String   @id @default(cuid())
  category    String
  value       String
  name        String
  description String?
  basePrice   Int
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  imageUrl    String?
  properties  Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([category, value])
  @@map("house_options")
}

model PricingRule {
  id               String   @id @default(cuid())
  nestType         String
  gebaeudehuelle   String
  innenverkleidung String
  fussboden        String
  totalPrice       Int
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([nestType, gebaeudehuelle, innenverkleidung, fussboden])
  @@map("pricing_rules")
}

model CustomerInquiry {
  id                String        @id @default(cuid())
  sessionId         String?
  email             String
  name              String?
  phone             String?
  message           String?
  configurationData Json?
  totalPrice        Int?
  status            InquiryStatus @default(NEW)
  preferredContact  ContactMethod @default(EMAIL)
  bestTimeToCall    String?
  adminNotes        String?
  followUpDate      DateTime?
  assignedTo        String?
  
  // Appointment-related fields
  requestType       String?       // 'contact' or 'appointment'
  appointmentDateTime DateTime?   // Requested appointment date/time
  appointmentStatus AppointmentStatus @default(PENDING)
  appointmentConfirmedAt DateTime? // When admin confirmed the appointment
  appointmentExpiresAt DateTime?   // 24h timeout for unconfirmed appointments
  calendarEventId   String?       // Google Calendar event ID if created
  
  // Payment-related fields
  paymentIntentId   String?       // Stripe Payment Intent ID
  paymentStatus     PaymentStatus @default(PENDING)
  paymentMethod     String?       // card, bank_transfer, etc.
  stripeSessionId   String?       // Stripe Checkout Session ID
  paymentAmount     Int?          // Amount actually paid (may differ from totalPrice)
  paymentCurrency   String?       @default("eur")
  paidAt            DateTime?     // When payment was completed
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@map("customer_inquiries")
}

model InteractionEvent {
  id              String      @id @default(cuid())
  sessionId       String
  eventType       String      // 'click', 'hover', 'scroll', 'selection'
  category        String      // 'nest', 'gebaeudehuelle', 'ausstattung'
  elementId       String?
  selectionValue  String?
  previousValue   String?
  timestamp       DateTime    @default(now())
  timeSpent       BigInt?     // milliseconds - BigInt to handle large duration values
  deviceType      String?
  viewportWidth   Int?
  viewportHeight  Int?
  additionalData  Json?
  
  session         UserSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)
  
  @@map("interaction_events")
}

model PerformanceMetric {
  id              String   @id @default(cuid())
  sessionId       String?
  metricName      String   // 'api_response_time', 'image_load_time', 'price_calc_time'
  value           Float
  timestamp       DateTime @default(now())
  additionalData  Json?
  endpoint        String?
  userAgent       String?
  
  @@map("performance_metrics")
}

enum SessionStatus {
  ACTIVE
  IN_CART
  ABANDONED
  COMPLETED
  CONVERTED
  EXPIRED
}

enum InquiryStatus {
  NEW
  CONTACTED
  IN_PROGRESS
  QUOTED
  CONVERTED
  CLOSED
}

enum AppointmentStatus {
  PENDING       // Awaiting admin confirmation (24h hold)
  CONFIRMED     // Admin confirmed via RSVP
  CANCELLED     // Admin or customer cancelled
  EXPIRED       // 24h timeout passed without confirmation
}

enum ContactMethod {
  EMAIL
  PHONE
  WHATSAPP
}

enum PaymentStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
  CANCELLED
  REFUNDED
}

model UsabilityTest {
  id                String              @id @default(cuid())
  testId            String              @unique
  sessionId         String?
  testType          String              @default("alpha")
  status            TestStatus          @default(IN_PROGRESS)
  participantName   String?             // Name of the test participant
  startedAt         DateTime            @default(now())
  completedAt       DateTime?
  totalDuration     Int?                // milliseconds
  deviceInfo        Json?               // device, browser, viewport
  ipAddress         String?
  userAgent         String?
  comments          String?             // User comments/notes throughout the test
  startUrl          String?             // Starting URL for the test
  
  // Test results
  responses         UsabilityResponse[]
  interactions      TestInteraction[]
  
  // Summary metrics
  overallRating     Float?              // 1-10 average
  completionRate    Float?              // percentage completed
  errorCount        Int                 @default(0)
  consoleErrors     Json?               // captured console errors
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  @@map("usability_tests")
}

model UsabilityResponse {
  id              String         @id @default(cuid())
  testId          String
  questionId      String         // unique identifier for each question
  questionType    QuestionType   // RATING, TEXT, MULTIPLE_CHOICE
  questionText    String
  response        Json           // flexible response storage
  responseTime    Int?           // milliseconds to answer
  timestamp       DateTime       @default(now())
  
  test            UsabilityTest  @relation(fields: [testId], references: [testId], onDelete: Cascade)
  
  @@map("usability_responses")
}

model TestInteraction {
  id              String         @id @default(cuid())
  testId          String
  stepId          String         // which test step/page
  eventType       String         // click, scroll, navigation, error
  elementId       String?
  elementText     String?
  timestamp       DateTime       @default(now())
  duration        Int?           // time spent on this step
  success         Boolean        @default(true)
  errorMessage    String?
  additionalData  Json?
  
  test            UsabilityTest  @relation(fields: [testId], references: [testId], onDelete: Cascade)
  
  @@map("test_interactions")
}

enum TestStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
  ERROR
}

enum QuestionType {
  RATING
  TEXT
  MULTIPLE_CHOICE
  YES_NO
}

model ProjectTask {
  id           String       @id @default(cuid())
  taskId       String       @unique // e.g., "P1", "1.1", "M1", etc.
  task         String       // Task description
  responsible  String       // Team member(s) responsible
  startDate    DateTime     // Start date
  endDate      DateTime     // End date
  duration     Int          // Duration in days
  milestone    Boolean      @default(false) // Is this a milestone?
  priority     TaskPriority @default(MITTEL)
  notes        String?      // Additional notes
  status       TaskStatus   @default(PENDING)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@map("project_tasks")
}

enum TaskPriority {
  HÃ–CHST
  HOCH
  MITTEL
  NIEDRIG
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Security Event Tracking Models
model SecurityEvent {
  id              String            @id @default(cuid())
  sessionId       String?
  timestamp       DateTime          @default(now())
  eventType       SecurityEventType
  severity        EventSeverity
  source          String            @default("system")
  description     String
  metadata        Json?
  resolved        Boolean           @default(false)
  responseActions Json?             // Array of automated response actions taken
  ipAddress       String?
  userAgent       String?
  endpoint        String?
  
  @@index([sessionId])
  @@index([eventType])
  @@index([severity])
  @@index([timestamp])
  @@map("security_events")
}

model ThreatAlert {
  id                  String            @id @default(cuid())
  timestamp           DateTime          @default(now())
  eventType           SecurityEventType
  severity            EventSeverity
  title               String
  description         String
  affectedSessions    Json?             // Array of session IDs
  recommendedActions  Json?             // Array of recommended actions
  autoResolved        Boolean           @default(false)
  resolvedAt          DateTime?
  resolvedBy          String?
  
  @@index([eventType])
  @@index([severity])
  @@index([autoResolved])
  @@index([timestamp])
  @@map("threat_alerts")
}

model BehaviorAnalysis {
  id                String    @id @default(cuid())
  sessionId         String
  timestamp         DateTime  @default(now())
  suspicionScore    Float     // 0-1
  botProbability    Float     // 0-1
  humanLikelihood   Float     // 0-1
  anomalies         Json?     // Array of detected anomalies
  confidence        Float     // 0-1
  riskLevel         RiskLevel
  
  // Behavioral metrics
  mouseMovements    Int       @default(0)
  keystrokes        Int       @default(0)
  clicks            Int       @default(0)
  scrollEvents      Int       @default(0)
  sessionDuration   Int?      // milliseconds
  
  @@index([sessionId])
  @@index([riskLevel])
  @@index([timestamp])
  @@map("behavior_analyses")
}

model BotDetection {
  id                String          @id @default(cuid())
  sessionId         String
  timestamp         DateTime        @default(now())
  isBot             Boolean
  confidence        Float           // 0-1
  detectionMethods  Json?           // Array of detection methods used
  riskLevel         RiskLevel
  allowAccess       Boolean
  reasons           Json?           // Array of detection reasons
  userAgent         String?
  ipAddress         String?
  
  // Browser fingerprint data
  fingerprint       Json?
  
  @@index([sessionId])
  @@index([isBot])
  @@index([riskLevel])
  @@index([timestamp])
  @@map("bot_detections")
}

model SecurityMetrics {
  id                    String    @id @default(cuid())
  timestamp             DateTime  @default(now())
  activeSessions        Int       @default(0)
  totalEvents           Int       @default(0)
  threatLevel           ThreatLevel @default(NORMAL)
  eventsByType          Json?     // Object with event type counts
  eventsBySeverity      Json?     // Object with severity counts
  averageRiskScore      Float     @default(0)
  botDetectionRate      Float     @default(0)
  falsePositiveRate     Float     @default(0)
  responseTime          Float     @default(0) // Average response time in ms
  
  @@index([timestamp])
  @@index([threatLevel])
  @@map("security_metrics")
}

model ContentProtectionViolation {
  id            String    @id @default(cuid())
  sessionId     String?
  timestamp     DateTime  @default(now())
  violationType String    // right_click, text_selection, copy_attempt, etc.
  elementId     String?
  elementType   String?
  userAgent     String?
  ipAddress     String?
  blocked       Boolean   @default(false)
  
  @@index([sessionId])
  @@index([violationType])
  @@index([timestamp])
  @@map("content_protection_violations")
}

// Enums for security tracking
enum SecurityEventType {
  BOT_DETECTION
  BEHAVIORAL_ANOMALY
  RATE_LIMIT_EXCEEDED
  SUSPICIOUS_ACTIVITY
  CONTENT_PROTECTION_VIOLATION
  DEVTOOLS_DETECTION
  INJECTION_ATTEMPT
  BRUTE_FORCE_ATTEMPT
  DATA_BREACH_ATTEMPT
  UNAUTHORIZED_ACCESS
  PERFORMANCE_ANOMALY
}

enum EventSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ThreatLevel {
  NORMAL
  ELEVATED
  HIGH
  CRITICAL
}

// ===== PRICING SYNC MODELS =====

model PricingData {
  id            String   @id @default(cuid())
  category      String   // e.g., "nest_groesse", "gebaeudehuelle", "fenster"
  itemKey       String   // Unique identifier within category
  itemName      String   // Human-readable name
  basePrice     Int      // Base price in cents (EUR)
  priceModifier Int      @default(0) // Price modifier in cents (+/-)
  metadata      Json?    // Additional data (dimensions, descriptions, etc.)
  isActive      Boolean  @default(true)
  version       Int      @default(1) // Increments on each update
  lastSynced    DateTime @updatedAt
  createdAt     DateTime @default(now())
  
  @@unique([category, itemKey])
  @@index([category])
  @@index([isActive])
  @@map("pricing_data")
}

// Shadow copy of complete pricing data from Google Sheets
model PricingDataSnapshot {
  id            String   @id @default(cuid())
  version       Int      @default(1) // Increments on each sync
  pricingData   Json     // Complete PricingData structure from pricing-sheet-service
  syncedAt      DateTime @default(now())
  syncedBy      String   @default("cron") // "cron" | "manual" | "api"
  isActive      Boolean  @default(true) // Only one active snapshot at a time
  createdAt     DateTime @default(now())
  
  @@index([isActive])
  @@index([syncedAt])
  @@index([version])
  @@map("pricing_data_snapshots")
}