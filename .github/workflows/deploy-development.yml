name: Deploy to Development

on:
  push:
    branches: [development]
  workflow_dispatch: # Allow manual triggering

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run type checking
        run: npx tsc --noEmit

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Trigger Vercel deployment
        run: |
          echo "ðŸš€ Triggering Vercel deployment via deploy hook..."
          RESPONSE=$(curl -X POST "https://api.vercel.com/v1/integrations/deploy/prj_RdCUnkmNbHG7A1Upbw4QUPHKRwbc/3gtjg3tlyB" \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}" \
            -s)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            echo "âœ… Deployment triggered successfully"
            # Extract job ID if available
            JOB_ID=$(echo "$BODY" | grep -o '"id":"[^"]*"' | cut -d'"' -f4)
            if [ -n "$JOB_ID" ]; then
              echo "ðŸ”„ Deployment Job ID: $JOB_ID"
            fi
          else
            echo "âŒ Failed to trigger deployment"
            exit 1
          fi

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Development Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: development" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build successful" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Linting passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Type checking passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Vercel deployment triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Deploy Hook**: https://api.vercel.com/v1/integrations/deploy/prj_RdCUnkmNbHG7A1Upbw4QUPHKRwbc/3gtjg3tlyB" >> $GITHUB_STEP_SUMMARY

      - name: Notify deployment status
        if: failure()
        run: |
          echo "âŒ Deployment failed!" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
