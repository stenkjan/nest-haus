# Map Coordinate Debugging Guide

## Current Issue

Location dots are rendering in incorrect positions on the map, suggesting a mismatch between our coordinate calculations and the `react-svg-worldmap` library's actual rendering.

## Debugging Steps

### 1. Inspect the Actual SVG in Browser

1. Navigate to `/admin/user-tracking` and switch to Map View
2. Open browser DevTools (F12)
3. Go to the Elements/Inspector tab
4. Find the SVG elements generated by `react-svg-worldmap`

Look for:
```html
<svg height="XXXpx" width="YYYpx">
  <g transform="translate(...) scale(...) translate(...)">
    <!-- Map paths here -->
  </g>
</svg>
```

### 2. Check the Transform Values

The library may use different transform values than we're assuming. Current assumption:
```
scale(0.7125) translate(0, 240)
```

**Action**: Copy the actual `transform` attribute from the browser and compare.

### 3. Verify the ViewBox

Check if the library's SVG has a `viewBox` attribute:
```html
<svg viewBox="X Y W H" ...>
```

**Current assumption**: No viewBox, or `0 0 960 500` internally

### 4. Test with Known Coordinates

Add console logs to see actual calculated coordinates:

```typescript
// In GeoLocationMap.tsx, add:
console.log(`${city.city}: lat=${city.lat}, lng=${city.lng} → x=${x}, y=${y}`);
```

Expected results for test cities:
- **Vienna** (48.21°, 16.37°): Should be in Austria (central Europe)
- **New York** (40.71°, -74.01°): Should be on US East Coast
- **Tokyo** (35.68°, 139.65°): Should be in Japan

### 5. Measure Actual Map Positions

In browser DevTools console:
```javascript
// Get the base map's bounding box
const mapSvg = document.querySelector('[data-testid="svg-map"]') || 
               document.querySelector('svg'); // Fallback
console.log('Map dimensions:', mapSvg.getBoundingClientRect());

// Get a specific country path (e.g., Austria)
const austriaPath = Array.from(document.querySelectorAll('path'))
  .find(p => p.getAttribute('data-country') === 'AT');
console.log('Austria bounds:', austriaPath?.getBBox());
```

## Common Coordinate System Issues

### Issue 1: Wrong Base Dimensions

**Symptom**: All dots shifted uniformly in one direction  
**Cause**: Base coordinate system isn't 960×500  
**Fix**: Adjust base dimensions

### Issue 2: Wrong Transform

**Symptom**: Dots appear scaled incorrectly or offset  
**Cause**: Transform values don't match library's actual transform  
**Fix**: Copy exact transform from browser inspector

### Issue 3: Different Projection

**Symptom**: Some regions correct, others completely wrong  
**Cause**: Library uses different Mercator projection formula  
**Fix**: Research library's source code or use simpler lat/lng mapping

### Issue 4: Coordinate Origin

**Symptom**: Dots mirrored or inverted  
**Cause**: Y-axis direction or coordinate origin mismatch  
**Fix**: Invert Y calculation or adjust origin

## Quick Test: Disable Transform

Try removing all transforms temporarily to see raw coordinates:

```tsx
// Simplified version (no transform)
const x = ((city.lng + 180) / 360) * 1104; // Direct map to viewBox width
const y = ((90 - city.lat) / 180) * 513;   // Simple linear lat mapping
```

If this works better, it means the library doesn't use Mercator or uses a different transform.

## Library Investigation

Check the `react-svg-worldmap` source code or documentation:
```bash
# Find the installed package
ls node_modules/react-svg-worldmap/

# Check if there's a source file
cat node_modules/react-svg-worldmap/dist/index.js | grep -A 10 "viewBox\|transform"
```

## Alternative: Use Library's Coordinate System Directly

If the library exposes coordinate helpers, use them:
```typescript
import WorldMap, { getCoordinates } from "react-svg-worldmap";
// Use library's own coordinate calculation
```

## Next Steps

Based on your findings from the browser inspector:
1. Report the actual `transform` attribute value
2. Report the actual SVG dimensions and viewBox
3. Try the simplified no-transform version above

This will help us understand what coordinate system the library actually uses.

---

**Status**: Debugging in progress  
**Last Updated**: 2025-11-21

